{% extends "base.html" %}

{% block title %}Recalculate Track - GPS Tracking{% endblock %}

{% block content %}
<!-- Include Chart CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/chart.css') }}">

<h1>Recalculate Track Statistics</h1>

<div class="form-group track-name-group">
    <label class="track-label">Track Name:</label>
    <span class="track-name">{{ track.track_name }}</span>
</div>

<!-- Speed Chart Section -->
<div class="speed-chart-container">
    <label>Speed Profile:</label>
    <div class="chart-wrapper">
        
        <!-- Time labels -->
        <div class="chart-time-label chart-time-start">
            {% if track.start_time %}
                {{ track.start_time.strftime('%H:%M:%S') }}
            {% else %}
                Start
            {% endif %}
        </div>
        <div class="chart-time-label chart-time-end">
            {% if track.end_time %}
                {{ track.end_time.strftime('%H:%M:%S') }}
            {% else %}
                End
            {% endif %}
        </div>
        
        <!-- Chart content will be rendered here -->
        <canvas id="speedChart" class="chart-canvas"></canvas>
        
        <!-- Chart info overlay -->
        <div class="chart-info-overlay">
            <div>Sampling: {{ track.skip_points + 1 }}-second intervals</div>
            <div>Data Points: <span id="dataPointCount">Loading...</span></div>
        </div>
    </div>
</div>

<div class="form-group">
    <label>Current Statistics:</label>
    <div style="padding: 10px; background-color: #f8f9fa; border-radius: 4px; margin-bottom: 15px;">
        Max Speed: {{ "%.2f"|format(track.max_speed or 0) }} km/h<br>
        Avg Speed: {{ "%.2f"|format(track.avg_speed or 0) }} km/h<br>
        Current Sampling: {{ track.skip_points + 1 }}-second intervals
    </div>
</div>

<!-- Chart.js Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<!-- Set track ID for JavaScript -->
<script>
    console.log('Setting trackId:', {{ track.track_id }});  // debug
    window.trackId = {{ track.track_id }};
</script>
<script src="{{ url_for('static', filename='js/chart_speed.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>

<form method="post">
    <div class="form-group">
        <label for="skip_points">New Speed Calculation Sampling Rate:</label>
        {% set interval_labels = [
            "Highest", "Very High", "Higher", "High", "Medium",
            "Low", "Lower", "Very Low", "Ultra Low", "Maximum Smoothing"
        ] %}
        {% set skip = track.skip_points if track.skip_points is not none else 0 %}

        <select name="skip_points" id="skip_points">
        {% for i in range(10) %}
            <option value="{{ i }}" {% if skip == i %}selected{% endif %}>
            {{ interval_labels[i] }} ({{ i+1 }}-second intervals)
            </option>
        {% endfor %}
        </select>
        <div class="file-info">
            <strong>Effect of Different Sampling Rates:</strong><br>
            • Higher rates: More sensitive, may show GPS noise spikes<br>
            • Lower rates: Smoother results, filters out GPS errors<br>
            • Your original 695.1 km/h spike would likely be filtered with lower rates
        </div>
    </div>
    
    <button type="submit" class="btn full-width">Recalculate Track Statistics</button>
</form>
{% endblock %}